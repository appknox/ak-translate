<template>
  <div class="contain-height">
    <div v-if="enVulnerability" class="vuln--read">
      <div class="vuln__row">
        <section class="vuln__col">
          <div class="vuln__lang">
            <LanguageDisplay v-bind:language="'en'" />
          </div>
        </section>
        <section class="vuln__col">
          <div class="vuln__lang">
            <LanguageDisplay v-bind:language="language" />
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.name.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates('name', enVulnerability, langVulnerability)
            }"
          >
            Title
          </div>
          <div class="vuln__name">
            <v-md-editor
              v-model="enVulnerability.name.content"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' + formatDate(langVulnerability.name.updatedOn)
              "
            >
              Title
            </div>
            <div class="vuln__section__editable vuln__name">
              <textarea
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyName }"
                rows="3"
                v-model="langVulnerability.name.content"
                @change="cacheNameForCommit"
              ></textarea>
            </div>
          </div>
          <div v-else class="vuln__section__heading">Not found!</div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.question.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'question',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Question
          </div>
          <div class="vuln__question">
            <v-md-editor
              v-model="enVulnerability.question.content"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' + formatDate(langVulnerability.question.updatedOn)
              "
            >
              Question
            </div>
            <div class="vuln__section__editable vuln__question">
              <textarea
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyQuestion }"
                rows="4"
                v-model="langVulnerability.question.content"
                @change="cacheQuestionForCommit"
              ></textarea>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.summary.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates('summary', enVulnerability, langVulnerability)
            }"
          >
            Summary
          </div>
          <div class="vuln__summary">
            <v-md-editor
              v-model="enVulnerability.summary.content"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' + formatDate(langVulnerability.summary.updatedOn)
              "
            >
              Summary
            </div>
            <div class="vuln__section__editable vuln__summary">
              <v-md-editor
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtySummary }"
                v-model="langVulnerability.summary.content"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheSummaryForCommit"
              ></v-md-editor>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.description.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'description',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Description
          </div>
          <div class="vuln__desc">
            <v-md-editor
              v-model="enVulnerability.description.content"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' +
                  formatDate(langVulnerability.description.updatedOn)
              "
            >
              Description
            </div>
            <div class="vuln__section__editable vuln__desc">
              <v-md-editor
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtyDescription }"
                v-model="langVulnerability.description.content"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheDescriptionForCommit"
              ></v-md-editor>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' +
                formatDate(enVulnerability.businessImplication.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'businessImplication',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Business Implication
          </div>
          <div class="vuln__business-implication">
            <v-md-editor
              v-if="enVulnerability.businessImplication"
              v-model="enVulnerability.businessImplication.content"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' +
                  formatDate(langVulnerability.businessImplication.updatedOn)
              "
            >
              Business Implication
            </div>
            <div class="vuln__section__editable vuln__business-implication">
              <v-md-editor
                v-if="enVulnerability.businessImplication"
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtyBusinessImplication }"
                v-model="langVulnerability.businessImplication.content"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheBusinessImplicationForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.compliant.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'compliant',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Compliant
          </div>
          <div class="vuln__compliant">
            <v-md-editor
              v-if="enVulnerability.compliant"
              v-model="enVulnerability.compliant.content"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' +
                  formatDate(langVulnerability.compliant.updatedOn)
              "
            >
              Compliant
            </div>
            <div class="vuln__section__editable vuln__compliant">
              <v-md-editor
                v-if="enVulnerability.compliant"
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtyCompliant }"
                v-model="langVulnerability.compliant.content"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheCompliantForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.nonCompliant.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'nonCompliant',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Non Compliant
          </div>
          <div class="vuln__non-compliant">
            <v-md-editor
              v-if="enVulnerability.nonCompliant"
              v-model="enVulnerability.nonCompliant.content"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' +
                  formatDate(langVulnerability.nonCompliant.updatedOn)
              "
            >
              Non Compliant
            </div>
            <div class="vuln__section__editable vuln__non-compliant">
              <v-md-editor
                v-if="enVulnerability.nonCompliant"
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtyNonCompliant }"
                v-model="langVulnerability.nonCompliant.content"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheNonCompliantForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' +
                formatDate(enVulnerability.successMessage.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'successMessage',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Success Message
          </div>
          <div class="vuln__success-message">
            <v-md-editor
              v-model="enVulnerability.successMessage.content"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' +
                  formatDate(langVulnerability.successMessage.updatedOn)
              "
            >
              Success Message
            </div>
            <div class="vuln__section__editable vuln__success-message">
              <textarea
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtySuccessMessage }"
                rows="4"
                v-model="langVulnerability.successMessage.content"
                @change="cacheSuccessMessageForCommit"
              ></textarea>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div
            class="vuln__section__heading"
            v-bind:title="
              'Updated on ' + formatDate(enVulnerability.relatedTo.updatedOn)
            "
            v-bind:class="{
              updated: hasUpdates(
                'relatedTo',
                enVulnerability,
                langVulnerability
              )
            }"
          >
            Related To
          </div>
          <div class="vuln__related-to">
            <v-md-editor
              v-if="enVulnerability.relatedTo"
              v-model="enVulnerability.relatedTo.content"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div
              class="vuln__section__heading"
              v-bind:title="
                'Updated on ' +
                  formatDate(langVulnerability.relatedTo.updatedOn)
              "
            >
              Related To
            </div>
            <div class="vuln__section__editable vuln__related-to">
              <v-md-editor
                v-if="enVulnerability.relatedTo"
                class="vuln__md-editor"
                v-bind:class="{ dirty: isDirtyRelatedTo }"
                v-model="langVulnerability.relatedTo.content"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheRelatedToForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { Component, Prop, Watch, Vue } from "vue-property-decorator";
import dayjs from "dayjs";
import VulnerabilityType from "../types/VulnerabilityType";
import languageIcon from "@/shared/languageIcon";
import LanguageDisplay from "@/components/LanguageDisplay.vue";
import hash from "object-hash";

@Component({
  components: {
    LanguageDisplay
  }
})
export default class VulnerabilityTranslate extends Vue {
  @Prop() private enVulnerability!: VulnerabilityType;
  @Prop() private langVulnerability!: VulnerabilityType;
  @Prop() private language!: string;

  private languageIcon = languageIcon;
  private isDirtyName = false;
  private isDirtyQuestion = false;
  private isDirtySummary = false;
  private isDirtyDescription = false;
  private isDirtyBusinessImplication = false;
  private isDirtyCompliant = false;
  private isDirtyNonCompliant = false;
  private isDirtySuccessMessage = false;
  private isDirtyRelatedTo = false;

  @Watch("$store.state.modifiedVulnerabilitiesCounter")
  private watchModifiedVulnerabilities() {
    this.checkDirtyFlags();
  }

  checkDirtyFlags() {
    this.setIsDirtyName();
    this.setIsDirtyQuestion();
    this.setIsDirtySummary();
    this.setIsDirtyDescription();
    this.setIsDirtyBusinessImplication();
    this.setIsDirtyCompliant();
    this.setIsDirtyNonCompliant();
    this.setIsDirtySuccessMessage();
    this.setIsDirtyRelatedTo();
  }

  modifiedVulnerability() {
    if (!this.language) {
      return;
    }
    if (!this.langVulnerability) {
      return;
    }
    const modifiedVulns = localStorage.getItem("modifiedVulnerabilities");
    if (!modifiedVulns) {
      return;
    }
    const mvs = JSON.parse(modifiedVulns);
    if (!mvs[this.language] || !Object.keys(mvs[this.language]).length) {
      return;
    }
    return mvs[this.language][this.langVulnerability.id].vulnerability;
  }

  setIsDirtyName() {
    const v = this.modifiedVulnerability();
    this.isDirtyName = !!(v && v.name && v.name.content);
  }

  setIsDirtyQuestion() {
    const v = this.modifiedVulnerability();
    this.isDirtyQuestion = !!(v && v.question && v.question.content);
  }

  setIsDirtySummary() {
    const v = this.modifiedVulnerability();
    this.isDirtySummary = !!(v && v.summary && v.summary.content);
  }

  setIsDirtyDescription() {
    const v = this.modifiedVulnerability();
    this.isDirtyDescription = !!(v && v.description && v.description.content);
  }

  setIsDirtyBusinessImplication() {
    const v = this.modifiedVulnerability();
    this.isDirtyBusinessImplication = !!(
      v &&
      v.businessImplication &&
      v.businessImplication.content
    );
  }

  setIsDirtyCompliant() {
    const v = this.modifiedVulnerability();
    this.isDirtyCompliant = !!(v && v.compliant && v.compliant.content);
  }

  setIsDirtyNonCompliant() {
    const v = this.modifiedVulnerability();
    this.isDirtyNonCompliant = !!(
      v &&
      v.nonCompliant &&
      v.nonCompliant.content
    );
  }

  setIsDirtySuccessMessage() {
    const v = this.modifiedVulnerability();
    this.isDirtySuccessMessage = !!(
      v &&
      v.successMessage &&
      v.successMessage.content
    );
  }

  setIsDirtyRelatedTo() {
    const v = this.modifiedVulnerability();
    this.isDirtyRelatedTo = !!(v && v.relatedTo && v.relatedTo);
  }

  cacheForCommit(name: string, value: string) {
    const mvs = localStorage.getItem("modifiedVulnerabilities");
    if (!mvs) {
      return;
    }
    const modifiedVulnerabilities = JSON.parse(mvs);
    if (!modifiedVulnerabilities[this.language]) {
      return;
    }
    const mv =
      modifiedVulnerabilities[this.language][this.langVulnerability.id];
    // const hashOrig = mv["hash"];
    const hashOrig = hash(mv.vulnerability);
    const hashCurr = hash(this.langVulnerability);

    if (hashCurr !== hashOrig) {
      const vs = localStorage.getItem("vulnerabilities");
      if (!vs) {
        return;
      }
      const vulnerabilities = JSON.parse(vs);
      const v = vulnerabilities[this.language][this.langVulnerability.id];
      if (!mv["vulnerability"]) {
        if (v[name].content !== value) {
          mv["vulnerability"] = {
            [name]: {
              content: value,
              updatedOn: new Date().toISOString()
            }
          };
        }
      } else if (!mv["vulnerability"][name]) {
        if (v[name].content !== value) {
          mv["vulnerability"][name] = {
            content: value,
            updatedOn: new Date().toISOString()
          };
        }
      } else if (mv["vulnerability"][name].content) {
        if (v[name].content === value) {
          delete mv["vulnerability"][name];
          if (Object.keys(mv["vulnerability"]).length == 0) {
            mv["vulnerability"] = null;
          }
        } else {
          mv["vulnerability"][name] = {
            content: value,
            updatedOn: new Date().toISOString()
          };
        }
      }
    } else {
      mv["vulnerability"] = null;
    }
    this.$store.commit("saveModifiedVulnerabilityField", {
      lang: this.language,
      id: this.langVulnerability.id,
      vulnerability: mv["vulnerability"]
    });
    localStorage.setItem(
      "modifiedVulnerabilities",
      JSON.stringify(modifiedVulnerabilities)
    );
    return;
  }

  cacheNameForCommit() {
    this.cacheForCommit("name", this.langVulnerability.name.content);
    this.setIsDirtyName();
    return;
  }
  cacheQuestionForCommit() {
    this.cacheForCommit("question", this.langVulnerability.question.content);
    this.setIsDirtyQuestion();
    return;
  }
  cacheSummaryForCommit() {
    this.cacheForCommit("summary", this.langVulnerability.summary.content);
    this.setIsDirtySummary();
    return;
  }
  cacheDescriptionForCommit() {
    this.cacheForCommit(
      "description",
      this.langVulnerability.description.content
    );
    this.setIsDirtyDescription();
    return;
  }
  cacheBusinessImplicationForCommit() {
    this.cacheForCommit(
      "businessImplication",
      this.langVulnerability.businessImplication.content
    );
    this.setIsDirtyBusinessImplication();
    return;
  }
  cacheCompliantForCommit() {
    this.cacheForCommit("compliant", this.langVulnerability.compliant.content);
    this.setIsDirtyCompliant();
    return;
  }
  cacheNonCompliantForCommit() {
    this.cacheForCommit(
      "nonCompliant",
      this.langVulnerability.nonCompliant.content
    );
    this.setIsDirtyNonCompliant();
    return;
  }
  cacheSuccessMessageForCommit() {
    this.cacheForCommit(
      "successMessage",
      this.langVulnerability.successMessage.content
    );
    this.setIsDirtySuccessMessage();
    return;
  }
  cacheRelatedToForCommit() {
    this.cacheForCommit("relatedTo", this.langVulnerability.relatedTo.content);
    this.setIsDirtyRelatedTo();
    return;
  }

  hasUpdates(field, enVulnerability, langVulnerability) {
    if (!langVulnerability) {
      return true;
    }
    if (
      new Date(enVulnerability[field].updatedOn) >
      new Date(langVulnerability[field].updatedOn)
    ) {
      return true;
    }
    return false;
  }

  formatDate(isoDate) {
    return dayjs(isoDate).format("MMMM D, YYYY h:mm A");
  }

  mounted() {
    this.checkDirtyFlags();
  }
}
</script>

<style scoped lang="scss">
$padding-h: 2rem;
.vuln {
  &--read {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: stretch;
    background: $vulnerability-split-bg;
  }
  &__row {
    display: flex;
  }
  &__col {
    flex: 1;
    width: 50%;
    padding-left: $padding-h;
    padding-right: $padding-h;
    word-break: break-all;
    white-space: normal;
  }
  &__section {
    margin-bottom: 3rem;
    &__heading {
      display: flex;
      align-items: center;
      padding-bottom: 0.5rem;
      text-transform: uppercase;
      font-size: 0.8rem;
      color: #a5a5a5;
      &.updated::after {
        content: "new changes";
        background: $color-waiting;
        color: white;
        margin-left: 0.5rem;
        padding: 0.01rem 0.3rem 0.015rem;
        border-radius: 0.1rem;
        text-transform: uppercase;
        font-size: 0.57rem;
        font-weight: 600;
      }
    }
  }
  &__lang {
    text-align: center;
    padding: 1.5rem;
  }
  &__textarea {
    width: 100%;
    border: 2px solid darken($color-bg, 10%);
    border-radius: $border-radius;
    height: 100%;
    padding: 0.4rem 0.6rem;
    &.dirty {
      border-color: $color-dirty;
    }
  }
  &__md-editor {
    width: 100%;
    border: 2px solid darken($color-bg, 10%);
    border-radius: $border-radius;
    height: 100%;
    &.dirty {
      border-color: $color-dirty;
    }
  }
}
</style>
