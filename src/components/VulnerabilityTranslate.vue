<template>
  <div class="contain-height">
    <div v-if="enVulnerability" class="vuln--read">
      <div class="vuln__row">
        <section class="vuln__col">
          <div class="vuln__lang">{{ languageIcon("en") }} en</div>
        </section>
        <section class="vuln__col">
          <div class="vuln__lang">
            {{ languageIcon(language) }} {{ language }}
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Title</div>
          <div class="vuln__name">
            <v-md-editor
              v-model="enVulnerability.name"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Title</div>
            <div class="vuln__section__editable vuln__name">
              <textarea
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyName }"
                rows="3"
                v-model="langVulnerability.name"
                @change="cacheNameForCommit"
              ></textarea>
            </div>
          </div>
          <div v-else class="vuln__section__heading">Not found!</div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Question</div>
          <div class="vuln__question">
            <v-md-editor
              v-model="enVulnerability.question"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Question</div>
            <div class="vuln__section__editable vuln__question">
              <textarea
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyQuestion }"
                rows="4"
                v-model="langVulnerability.question"
                @change="cacheQuestionForCommit"
              ></textarea>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Summary</div>
          <div class="vuln__summary">
            <v-md-editor
              v-model="enVulnerability.summary"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Summary</div>
            <div class="vuln__section__editable vuln__summary">
              <v-md-editor
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtySummary }"
                v-model="langVulnerability.summary"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheSummaryForCommit"
              ></v-md-editor>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Description</div>
          <div class="vuln__desc">
            <v-md-editor
              v-model="enVulnerability.description"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Description</div>
            <div class="vuln__section__editable vuln__desc">
              <v-md-editor
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyDescription }"
                v-model="langVulnerability.description"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheDescriptionForCommit"
              ></v-md-editor>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Business Implication</div>
          <div class="vuln__business-implication">
            <v-md-editor
              v-if="enVulnerability.businessImplication"
              v-model="enVulnerability.businessImplication"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Business Implication</div>
            <div class="vuln__section__editable vuln__business-implication">
              <v-md-editor
                v-if="enVulnerability.businessImplication"
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyBusinessImplication }"
                v-model="langVulnerability.businessImplication"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheBusinessImplicationForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Compliant</div>
          <div class="vuln__compliant">
            <v-md-editor
              v-if="enVulnerability.compliant"
              v-model="enVulnerability.compliant"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Compliant</div>
            <div class="vuln__section__editable vuln__compliant">
              <v-md-editor
                v-if="enVulnerability.compliant"
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyCompliant }"
                v-model="langVulnerability.compliant"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheCompliantForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Non Compliant</div>
          <div class="vuln__non-compliant">
            <v-md-editor
              v-if="enVulnerability.nonCompliant"
              v-model="enVulnerability.nonCompliant"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Non Compliant</div>
            <div class="vuln__section__editable vuln__non-compliant">
              <v-md-editor
                v-if="enVulnerability.nonCompliant"
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyNonCompliant }"
                v-model="langVulnerability.nonCompliant"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheNonCompliantForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Success Message</div>
          <div class="vuln__success-message">
            <v-md-editor
              v-model="enVulnerability.successMessage"
              mode="preview"
            ></v-md-editor>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Success Message</div>
            <div class="vuln__section__editable vuln__success-message">
              <textarea
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtySuccessMessage }"
                rows="4"
                v-model="langVulnerability.successMessage"
                @change="cacheSuccessMessageForCommit"
              ></textarea>
            </div>
          </div>
        </section>
      </div>

      <div class="vuln__row">
        <section class="vuln__col vuln__section">
          <div class="vuln__section__heading">Related To</div>
          <div class="vuln__related-to">
            <v-md-editor
              v-if="enVulnerability.relatedTo"
              v-model="enVulnerability.relatedTo"
              mode="preview"
            ></v-md-editor>
            <div v-else>_</div>
          </div>
        </section>
        <section class="vuln__col vuln__section">
          <div class="vuln__section__lang" v-if="langVulnerability">
            <div class="vuln__section__heading">Related To</div>
            <div class="vuln__section__editable vuln__related-to">
              <v-md-editor
                v-if="enVulnerability.relatedTo"
                class="vuln__textarea"
                v-bind:class="{ dirty: isDirtyRelatedTo }"
                v-model="langVulnerability.relatedTo"
                mode="edit"
                left-toolbar="h bold italic ul ol link code"
                right-toolbar="preview fullscreen"
                @change="cacheRelatedToForCommit"
              ></v-md-editor>
              <div v-else>_</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { Component, Prop, Watch, Vue } from "vue-property-decorator";
import VulnerabilityType from "../types/VulnerabilityType";
import languageIcon from "@/shared/languageIcon";
import hash from "object-hash";

@Component
export default class VulnerabilityTranslate extends Vue {
  @Prop() private enVulnerability!: VulnerabilityType;
  @Prop() private langVulnerability!: VulnerabilityType;
  @Prop() private language!: string;

  private languageIcon = languageIcon;
  private isDirtyName = false;
  private isDirtyQuestion = false;
  private isDirtySummary = false;
  private isDirtyDescription = false;
  private isDirtyBusinessImplication = false;
  private isDirtyCompliant = false;
  private isDirtyNonCompliant = false;
  private isDirtySuccessMessage = false;
  private isDirtyRelatedTo = false;

  @Watch("$store.state.modifiedVulnerabilitiesCounter")
  private watchModifiedVulnerabilities() {
    this.checkDirtyFlags();
  }

  checkDirtyFlags() {
    this.setIsDirtyName();
    this.setIsDirtyQuestion();
    this.setIsDirtySummary();
    this.setIsDirtyDescription();
    this.setIsDirtyBusinessImplication();
    this.setIsDirtyCompliant();
    this.setIsDirtyNonCompliant();
    this.setIsDirtySuccessMessage();
    this.setIsDirtyRelatedTo();
  }

  modifiedVulnerability() {
    if (!this.language) {
      return;
    }
    if (!this.langVulnerability) {
      return;
    }
    const modifiedVulns = localStorage.getItem("modifiedVulnerabilities");
    if (!modifiedVulns) {
      return;
    }
    const mvs = JSON.parse(modifiedVulns);
    if (!mvs[this.language] || !Object.keys(mvs[this.language]).length) {
      return;
    }
    return mvs[this.language][this.langVulnerability.id].vulnerability;
  }

  setIsDirtyName() {
    const v = this.modifiedVulnerability();
    this.isDirtyName = !!(v && v.name);
  }

  setIsDirtyQuestion() {
    const v = this.modifiedVulnerability();
    this.isDirtyQuestion = !!(v && v.question);
  }

  setIsDirtySummary() {
    const v = this.modifiedVulnerability();
    this.isDirtySummary = !!(v && v.summary);
  }

  setIsDirtyDescription() {
    const v = this.modifiedVulnerability();
    this.isDirtyDescription = !!(v && v.description);
  }

  setIsDirtyBusinessImplication() {
    const v = this.modifiedVulnerability();
    this.isDirtyBusinessImplication = !!(v && v.businessImplication);
  }

  setIsDirtyCompliant() {
    const v = this.modifiedVulnerability();
    this.isDirtyCompliant = !!(v && v.compliant);
  }

  setIsDirtyNonCompliant() {
    const v = this.modifiedVulnerability();
    this.isDirtyNonCompliant = !!(v && v.nonCompliant);
  }

  setIsDirtySuccessMessage() {
    const v = this.modifiedVulnerability();
    this.isDirtySuccessMessage = !!(v && v.successMessage);
  }

  setIsDirtyRelatedTo() {
    const v = this.modifiedVulnerability();
    this.isDirtyRelatedTo = !!(v && v.relatedTo);
  }

  cacheForCommit(name: string, value: string) {
    const mvs = localStorage.getItem("modifiedVulnerabilities");
    if (!mvs) {
      return;
    }
    const modifiedVulnerabilities = JSON.parse(mvs);
    if (!modifiedVulnerabilities[this.language]) {
      return;
    }
    const mv =
      modifiedVulnerabilities[this.language][this.langVulnerability.id];
    const hashOrig = mv["hash"];
    const hashCurr = hash(this.langVulnerability);

    if (hashCurr !== hashOrig) {
      const vs = localStorage.getItem("vulnerabilities");
      if (!vs) {
        return;
      }
      const vulnerabilities = JSON.parse(vs);
      const v = vulnerabilities[this.language][this.langVulnerability.id];
      if (!mv["vulnerability"]) {
        if (v[name] !== value) {
          mv["vulnerability"] = {
            [name]: value
          };
        }
      } else if (!mv["vulnerability"][name]) {
        if (v[name] !== value) {
          mv["vulnerability"][name] = value;
        }
      } else if (mv["vulnerability"][name]) {
        if (v[name] === value) {
          delete mv["vulnerability"][name];
          if (Object.keys(mv["vulnerability"]).length == 0) {
            mv["vulnerability"] = null;
          }
        } else {
          mv["vulnerability"][name] = value;
        }
      }
    } else {
      mv["vulnerability"] = null;
    }
    this.$store.commit("saveModifiedVulnerabilityField", {
      lang: this.language,
      id: this.langVulnerability.id,
      vulnerability: mv["vulnerability"]
    });
    localStorage.setItem(
      "modifiedVulnerabilities",
      JSON.stringify(modifiedVulnerabilities)
    );
    return;
  }

  cacheNameForCommit() {
    this.cacheForCommit("name", this.langVulnerability.name);
    this.setIsDirtyName();
    return;
  }
  cacheQuestionForCommit() {
    this.cacheForCommit("question", this.langVulnerability.question);
    this.setIsDirtyQuestion();
    return;
  }
  cacheSummaryForCommit() {
    this.cacheForCommit("summary", this.langVulnerability.summary);
    this.setIsDirtySummary();
    return;
  }
  cacheDescriptionForCommit() {
    this.cacheForCommit("description", this.langVulnerability.description);
    this.setIsDirtyDescription();
    return;
  }
  cacheBusinessImplicationForCommit() {
    this.cacheForCommit(
      "businessImplication",
      this.langVulnerability.businessImplication
    );
    this.setIsDirtyBusinessImplication();
    return;
  }
  cacheCompliantForCommit() {
    this.cacheForCommit("compliant", this.langVulnerability.compliant);
    this.setIsDirtyCompliant();
    return;
  }
  cacheNonCompliantForCommit() {
    this.cacheForCommit("nonCompliant", this.langVulnerability.nonCompliant);
    this.setIsDirtyNonCompliant();
    return;
  }
  cacheSuccessMessageForCommit() {
    this.cacheForCommit(
      "successMessage",
      this.langVulnerability.successMessage
    );
    this.setIsDirtySuccessMessage();
    return;
  }
  cacheRelatedToForCommit() {
    this.cacheForCommit("relatedTo", this.langVulnerability.relatedTo);
    this.setIsDirtyRelatedTo();
    return;
  }

  mounted() {
    this.checkDirtyFlags();
  }
}
</script>

<style scoped lang="scss">
$padding-h: 2rem;
.vuln {
  &--read {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: stretch;
    background: $vulnerability-split-bg;
  }
  &__row {
    display: flex;
  }
  &__col {
    flex: 1;
    width: 50%;
    padding-left: $padding-h;
    padding-right: $padding-h;
    word-break: break-all;
    white-space: normal;
  }
  &__section {
    margin-bottom: 3rem;
    &__heading {
      text-transform: uppercase;
      font-size: 0.8rem;
      padding-bottom: 0.8em;
      color: #a5a5a5;
    }
  }
  &__lang {
    text-align: center;
    padding: 1.5rem;
    font-size: 1.2rem;
    font-weight: 600;
    color: #a6aab7;
  }
  &__textarea {
    width: 100%;
    border: 2px solid darken($color-bg, 10%);
    border-radius: $border-radius;
    height: 100%;
    &.dirty {
      border-color: $color-dirty;
    }
  }
}
</style>
