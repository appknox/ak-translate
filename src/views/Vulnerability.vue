<template>
  <div class="vulnerability contain-height">
    <NavBar class="sitenav">
      <BreadCrumb
        v-bind:breadcrumb="[
          { label: 'Projects', route: '/projects' },
          {
            label: 'Vulnerabilities',
            route: null
          },
          {
            label: $route.params.id,
            route: null
          }
        ]"
      />
    </NavBar>
    <div class="side-panel-layout">
      <aside class="sidebar">
        <nav class="vulnerability-nav">
          <h3 class="sidebar__header">Vulnerabilities</h3>
          <ul>
            <li
              v-for="v in sort(vulnerabilities)"
              :key="v.id"
              class="vuln-nav"
              v-bind:class="{ active: v.id == $route.params.id }"
            >
              <router-link v-bind:to="'/vulnerabilities/' + v.id">
                <div class="vuln-nav__id">{{ paddedNumber(v.id, 3) }}</div>
                <div class="vuln-nav__name">{{ v.name }}</div>
                <div
                  class="vuln-nav__platform"
                  v-bind:class="'vuln-nav__platform--' + v.platform"
                >
                  <PlatformIcon
                    v-bind:platform="v.platform"
                    height="20px"
                    width="20px"
                  />
                </div>
              </router-link>
            </li>
          </ul>
        </nav>
      </aside>
      <main class="main">
        <VulnerabilityView
          v-bind:vulnerability="getVulnerability($route.params.id)"
        />
      </main>
    </div>
  </div>
</template>

<script lang="ts">
import { Component, Vue } from "vue-property-decorator";
import NavBar from "@/components/NavBar.vue";
import BreadCrumb from "@/components/BreadCrumb.vue";
import VulnerabilityView from "@/components/VulnerabilityView.vue";
import PlatformIcon from "@/components/PlatformIcon.vue";
import RepoContentService from "@/services/RepoContentService";
import VulnerabilityType from "@/types/VulnerabilityType";

interface GithubRepoContentResponse {
  type: string;
  name: string;
  path: string;
  content: string;
  download_url: string;
}

@Component({
  components: {
    NavBar,
    BreadCrumb,
    VulnerabilityView,
    PlatformIcon
  }
})
export default class Vulnerability extends Vue {
  private id = this.$route.params;
  private vulnerabilities = [];

  getVulnerability(id: string): VulnerabilityType {
    return this.$store.getters.getVulnerability(parseInt(id));
  }

  async getVulnerabilities() {
    const vulnerabilities = localStorage.getItem("vulnerabilities");
    if (vulnerabilities) {
      this.vulnerabilities = JSON.parse(vulnerabilities);
      this.vulnerabilities.forEach(v => {
        this.$store.commit("saveVulnerability", v);
      });
      return;
    }

    const BRANCH = "master";
    const RAW_BASE_URL = `https://raw.githubusercontent.com/appknox/vulnerabilities/${BRANCH}`;
    const EN_DIR = "vulnerabilities";

    RepoContentService.get(EN_DIR).then(async response => {
      const tree: GithubRepoContentResponse[] = response.data;
      await Promise.all(
        tree.map(async content => {
          const vBaseUrlEn = `${RAW_BASE_URL}/${EN_DIR}/${content.name}`;

          let response = await fetch(`${vBaseUrlEn}/name.md`);
          const name = await response.text();

          response = await fetch(`${vBaseUrlEn}/question.md`);
          const question = await response.text();

          response = await fetch(`${vBaseUrlEn}/description.md`);
          const summary = await response.text();

          response = await fetch(`${vBaseUrlEn}/intro.md`);
          const description = await response.text();

          response = await fetch(`${vBaseUrlEn}/business_implication.md`);
          const businessImplication = await response.text();

          response = await fetch(`${vBaseUrlEn}/compliant.md`);
          const compliant = await response.text();

          response = await fetch(`${vBaseUrlEn}/non_compliant.md`);
          const nonCompliant = await response.text();

          response = await fetch(`${vBaseUrlEn}/success_message.md`);
          const successMessage = await response.text();

          response = await fetch(`${vBaseUrlEn}/related_to.md`);
          const relatedTo = await response.text();

          const [id, platform] = content.name.split("_");
          const vulnerability = {
            id: parseInt(id),
            key: content.name,
            platform: platform,
            name: name,
            question: question,
            summary: summary,
            description: description,
            businessImplication: businessImplication,
            compliant: compliant,
            nonCompliant: nonCompliant,
            successMessage: successMessage,
            relatedTo: relatedTo
          };
          this.$store.commit("saveVulnerability", vulnerability);
          return vulnerability;
        })
      );

      this.vulnerabilities = this.$store.getters.getVulnerabilities;
      localStorage.setItem(
        "vulnerabilities",
        JSON.stringify(this.vulnerabilities)
      );

      return;
    });
  }

  sort(arr: VulnerabilityType[]) {
    return arr.reduce((acc, curr) => {
      acc[curr.id] = curr;
      return acc;
    }, {});
  }

  paddedNumber(n: number, m: 3) {
    if (n < 10) {
      return `${"0".repeat(m - 1)}${n}`;
    }
    if (n < 100) {
      return `${"0".repeat(m - 2)}${n}`;
    }
    return `${n}`;
  }

  mounted() {
    this.getVulnerabilities();
  }
}
</script>

<style scoped lang="scss">
.sitenav {
  margin-bottom: -$navbar-height;
}
.side-panel-layout {
  height: 100%;
  padding-top: $navbar-height;
  display: flex;
  overflow: hidden;
}

$sidebar-padding: 1rem;
.sidebar {
  overflow-y: scroll;
  background: lighten($color-text, 70%);
  width: 100%;

  @media (min-width: 768px) {
    width: 20rem;
  }

  &__header {
    text-transform: uppercase;
    color: $sidebar-title-color;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.03rem;
    padding: 0.8rem 1rem 0.5rem;
  }
}
.main {
  overflow-y: scroll;
  width: 100%;
  flex: 1;
  background: $main-bg;
}

.vulnerability-nav {
  ul {
    padding: 0.3rem 0 2rem;
  }
  li {
    font-size: 0.9rem;
    &:not(:last-child) {
      border-bottom: 1px solid transparent;
    }
  }
}

.vuln-nav {
  a {
    padding: 0.3rem $sidebar-padding;
    display: flex;
    align-items: stretch;
    color: $sidebar-color;
    &:hover,
    &:focus {
      color: $color-primary;
    }
  }
  &__name {
    padding-left: 0.5rem;
  }
  &__platform {
    margin-left: auto;
    display: flex;
    align-items: center;
  }
  &.active {
    border-color: $sidebar-active-border-color;
    a {
      color: $sidebar-active-color;
      background: $sidebar-active-bg;
    }
  }
}
</style>

<style lang="scss">
.vuln-nav {
  &__platform {
    svg path {
      fill: $sidebar-platform-icon-color;
    }
  }
  &.active {
    .vuln-nav__platform {
      &--android svg path {
        fill: $sidebar-android-icon-color;
      }
      &--ios svg path {
        fill: $sidebar-ios-icon-color;
      }
      &--api svg path {
        fill: $sidebar-api-icon-color;
      }
      &--common svg path {
        fill: $sidebar-common-icon-color;
      }
    }
  }
}
</style>
