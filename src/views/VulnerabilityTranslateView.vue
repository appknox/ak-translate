<template>
  <div class="vulnerability contain-height">
    <NavBar
      class="sitenav"
      v-bind:showLanguageSwitch="true"
      v-bind:languageSwitchDisabled="languageSwitchDisabled"
    >
      <BreadCrumb
        v-bind:breadcrumb="[
          { label: 'Projects', route: '/projects' },
          {
            label: 'Vulnerabilities',
            route: null
          },
          {
            label: $route.params.id,
            route: `/vulnerabilities/${$route.params.id}`
          },
          {
            label: 'translate',
            route: null
          }
        ]"
      />
    </NavBar>
    <div class="side-panel-layout">
      <aside class="sidebar">
        <nav class="vulnerability-nav">
          <h3 class="sidebar__header">Translate Vulnerabilities</h3>
          <ul v-if="vulnerabilities">
            <li
              v-for="v in vulnerabilities.en"
              :key="v.id"
              class="vuln-nav"
              v-bind:class="{ active: v.id == $route.params.id }"
            >
              <SidebarVulnerability
                v-bind:vulnerability="v"
                v-bind:isActive="v.id == $route.params.id"
                v-bind:targetLanguage="language"
                v-bind:hasUpdates="isEnUpdated(v.updatedOn, v.id)"
              />
            </li>
          </ul>
          <div v-else>not loaded</div>
        </nav>
      </aside>
      <main class="main" v-if="hasEditBranch">
        <div v-if="isLoadingVulnerabilities" class="contain-centered">
          <div class="loader">
            <DownloadLoader />
            <div class="loader__msg">
              <div>Initializing Vulnerabilities...</div>
              <div class="loader__msg__sub">
                Please wait, this may take a few minutes.
              </div>
            </div>
          </div>
        </div>
        <div
          v-else-if="
            !isLoadingVulnerabilities &&
              !getVulnerability($route.params.id, 'en')
          "
          class="not-found contain-centered"
        >
          <AlertIcon />
          Uh oh! Vulnerability with this ID doesn't exist.
        </div>
        <VulnerabilityTranslate
          v-else
          v-bind:enVulnerability="getVulnerability($route.params.id, 'en')"
          v-bind:langVulnerability="
            getVulnerability($route.params.id, language)
          "
          v-bind:language="language"
          v-bind:loading="isLoadingVulnerabilities"
        />
      </main>
    </div>
    <FooterBar class="footer-bar" v-bind:language="language">
      <template v-slot:faq>
        <PopoverInfo
          msg="This page shows your translation changes until a submission is made. The past submissions which are not approved yet will not be visible here."
        />
      </template>
    </FooterBar>
  </div>
</template>

<script lang="ts">
import { Component, Watch, Vue } from "vue-property-decorator";
import dayjs from "dayjs";
import AlertIcon from "vue-material-design-icons/Alert.vue";
import VulnerabilityAPIService from "@/services/VulnerabilityAPIService";
import { LANGUAGES } from "@/shared/languages";
import NavBar from "@/components/NavBar.vue";
import FooterBar from "@/components/FooterBar.vue";
import BreadCrumb from "@/components/BreadCrumb.vue";
import DownloadLoader from "@/components/DownloadLoader.vue";
import VulnerabilityTranslate from "@/components/VulnerabilityTranslate.vue";
import PlatformIcon from "@/components/PlatformIcon.vue";
import SidebarVulnerability from "@/components/SidebarVulnerability.vue";
import PopoverInfo from "@/components/PopoverInfo.vue";

@Component({
  components: {
    NavBar,
    BreadCrumb,
    DownloadLoader,
    VulnerabilityTranslate,
    PlatformIcon,
    SidebarVulnerability,
    FooterBar,
    AlertIcon,
    PopoverInfo
  }
})
export default class VulnerabilityTranslateView extends Vue {
  private id = this.$route.params.id;
  private vulnerabilities = [];
  private languageSwitchDisabled = false;

  private branch = localStorage.getItem("branch");
  private language = "ja";
  private isLoadingVulnerabilities = true;
  private allLangs = LANGUAGES.map(l => l.key);
  private hasEditBranch = false;

  @Watch("$store.state.languageCounter")
  private watchLanguageSwitch() {
    this.language = this.$store.getters.getLanguage;
    this.getVulnerabilities();
  }

  @Watch("$store.state.modifiedVulnerabilitiesCounter")
  private watchModifiedVulnerabilities() {
    this.setLangSwitchDisabled();
  }

  getVulnerability(id: string, lang: string) {
    const vid = parseInt(id);
    const v = this.$store.getters.getVulnerability(vid, lang);
    return v;
  }

  hasAllLangVulns(vulnerabilities) {
    if (!vulnerabilities) {
      return false;
    }
    for (const lang of this.allLangs) {
      if (Object.keys(vulnerabilities[lang]).length === 0) {
        return false;
      }
    }
    return true;
  }

  initModifiedVulnerabilities() {
    const modifiedVulns = localStorage.getItem("modifiedVulnerabilities");
    if (modifiedVulns) {
      const mvs = JSON.parse(modifiedVulns);
      const isValidMVs = this.hasAllLangVulns(mvs);
      if (isValidMVs) {
        for (const lang of this.allLangs) {
          Object.keys(mvs[lang]).forEach(k => {
            this.$store.commit("saveModifiedVulnerability", {
              lang: lang,
              id: k,
              hash: mvs[lang][k]["hash"],
              vulnerability: mvs[lang][k]["vulnerability"]
            });
          });
        }
        return;
      }
    }

    this.$store.commit("initModifiedVulnerabilities");
    const modifiedVulnerabilities = this.$store.getters
      .getModifiedVulnerabilities;
    localStorage.setItem(
      "modifiedVulnerabilities",
      JSON.stringify(modifiedVulnerabilities)
    );
  }

  formatField(field) {
    return {
      content: field.content,
      updatedOn: field.updatedOn
    };
  }

  formatVulnerability(v) {
    return {
      id: v.id,
      key: v.key,
      platform: v.platform,
      updatedOn: v.updated_on,
      name: this.formatField(v.name),
      question: this.formatField(v.question),
      summary: this.formatField(v.description),
      description: this.formatField(v.intro),
      businessImplication: this.formatField(v.business_implication),
      compliant: this.formatField(v.compliant),
      nonCompliant: this.formatField(v.non_compliant),
      successMessage: this.formatField(v.success_message),
      relatedTo: this.formatField(v.related_to)
    };
  }

  async fetchVulnerabilities(branch = "master", langs = this.allLangs) {
    return await VulnerabilityAPIService.get(branch)
      .then(response => response.data)
      .then(data => {
        const vulnerabilities = {};
        for (const lang of langs) {
          vulnerabilities[lang] = data[lang].reduce((acc, curr) => {
            acc[curr.id] = this.formatVulnerability(curr);
            this.$store.commit("saveVulnerability", {
              lang: lang,
              id: curr.id,
              vulnerability: acc[curr.id]
            });
            return acc;
          }, {});
        }
        this.isLoadingVulnerabilities = false;
        return vulnerabilities;
      })
      .catch(() => {
        this.$toast.error(
          "Coudld not load translations for your session. Try reloading",
          {
            timeout: 5000
          }
        );
        const enVulns = this.$store.getters.getVulnerabilitiesForLang("en");
        for (const lang of langs) {
          Object.keys(enVulns).forEach(id => {
            this.$store.commit("saveVulnerability", {
              lang: lang,
              id: parseInt(id),
              vulnerability: null
            });
          });
        }
        this.isLoadingVulnerabilities = false;
        return;
      });
  }

  async getMasterVulnerabilities() {
    const masterCachedOn = localStorage.getItem("masterVulnCachedOn");
    if (
      masterCachedOn &&
      dayjs(masterCachedOn).diff(dayjs(), "hour") <
        parseInt(process.env.VUE_APP_CACHE_TIMEOUT)
    ) {
      const vulnerabilities = localStorage.getItem("masterVulnerabilities");
      if (vulnerabilities) {
        this.vulnerabilities = JSON.parse(vulnerabilities);
        if (this.hasAllLangVulns(this.vulnerabilities)) {
          for (const lang of this.allLangs) {
            Object.keys(this.vulnerabilities[lang]).forEach(k => {
              this.$store.commit("saveVulnerability", {
                lang: lang,
                id: k,
                vulnerability: this.vulnerabilities[lang][k]
              });
            });
          }
          return;
        }
      }
    }

    await this.fetchVulnerabilities("master", ["en"]);
    return;
  }

  async getVulnerabilities() {
    const cachedOn = localStorage.getItem("vulnCachedOn");
    if (
      cachedOn &&
      dayjs(cachedOn).diff(dayjs(), "hour") <
        parseInt(process.env.VUE_APP_CACHE_TIMEOUT)
    ) {
      const vulnerabilities = localStorage.getItem("vulnerabilities");
      if (vulnerabilities) {
        this.vulnerabilities = JSON.parse(vulnerabilities);
        if (this.hasAllLangVulns(this.vulnerabilities)) {
          for (const lang of this.allLangs) {
            Object.keys(this.vulnerabilities[lang]).forEach(k => {
              this.$store.commit("saveVulnerability", {
                lang: lang,
                id: k,
                vulnerability: this.vulnerabilities[lang][k]
              });
            });
          }
          this.isLoadingVulnerabilities = false;
          this.initModifiedVulnerabilities();
          return;
        }
      }
    }

    await this.getMasterVulnerabilities();
    if (this.$store.getters.hasEditBranch) {
      await this.fetchVulnerabilities(
        this.$store.getters.getBranch,
        this.allLangs.filter(l => l !== "en")
      );
    }
    this.vulnerabilities = await this.$store.getters.getVulnerabilities;

    localStorage.setItem(
      "vulnerabilities",
      JSON.stringify(this.vulnerabilities)
    );
    localStorage.setItem("vulnCachedOn", dayjs().toISOString());

    this.initModifiedVulnerabilities();
    return;
  }

  async setLangSwitchDisabled() {
    const modifiedVulns = localStorage.getItem("modifiedVulnerabilities");
    if (modifiedVulns) {
      const mvs = JSON.parse(modifiedVulns);
      const isValidMVs = this.hasAllLangVulns(mvs);
      if (isValidMVs) {
        for (const lang of this.allLangs) {
          const mvFiltered = await Object.keys(mvs[lang]).filter(
            k => !!mvs[lang][k]["vulnerability"]
          );
          if (mvFiltered.length > 0) {
            this.languageSwitchDisabled = true;
          } else {
            this.languageSwitchDisabled = false;
          }
        }
      }
    }
  }

  isEnUpdated(enUpdatedOn, enId) {
    if (!this.vulnerabilities[this.language][enId]) {
      return false;
    }
    if (!enUpdatedOn || this.vulnerabilities[this.language][enId].updatedOn) {
      return false;
    }
    if (
      new Date(enUpdatedOn) >
      new Date(this.vulnerabilities[this.language][enId].updatedOn)
    ) {
      return true;
    }
    return false;
  }

  sort(arr) {
    return arr.reduce((acc, curr) => {
      acc[curr.id] = curr;
      return acc;
    }, {});
  }

  async restoreModifiedVulnerability() {
    const mvs = await this.$store.getters.getModifiedVulnerabilities;
    for (const lang of this.allLangs) {
      await Object.keys(mvs[lang])
        .filter(k => !!mvs[lang][k]["vulnerability"])
        .forEach(k => {
          return Object.keys(mvs[lang][k]["vulnerability"]).forEach(f => {
            this.vulnerabilities[this.language][k][f] =
              mvs[lang][k]["vulnerability"][f];
          });
        });
    }
  }

  mounted() {
    this.hasEditBranch = this.$store.getters.hasEditBranch;
    if (!this.hasEditBranch) {
      this.$router.push({
        name: "vulnerability",
        params: {
          id: this.$route.params.id
        }
      });
    }

    this.$store.commit("initLanguage");
    this.language = this.$store.getters.getLanguage;

    this.getVulnerabilities();
    this.restoreModifiedVulnerability();
    this.setLangSwitchDisabled();
  }
}
</script>

<style scoped lang="scss">
.vulnerability {
  position: relative;
}
.sitenav {
  margin-bottom: -$navbar-height;
  z-index: 2;
}
.side-panel-layout {
  height: 100%;
  padding-top: $navbar-height;
  padding-bottom: $navbar-height;
  display: flex;
  overflow: hidden;
  position: relative;
  z-index: 1;
}
.footer-bar {
  height: $navbar-height;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1;
  box-shadow: -1px 0 12px rgba(lighten($color-text, 45%), 0.5);
  border-top: 1px solid lighten($color-text, 58%);
}

.sidebar {
  overflow-y: scroll;
  background: $sidebar-bg;
  width: 100%;

  @media (min-width: 768px) {
    width: 20rem;
  }

  &__header {
    text-transform: uppercase;
    color: $sidebar-title-color;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.03rem;
    padding: 0.8rem 1rem 0.5rem;
  }
}
.main {
  overflow-y: scroll;
  width: 100%;
  flex: 1;
  background: $main-bg;
}

.vulnerability-nav {
  ul {
    padding: 0.3rem 0 2rem;
  }
  li {
    &:not(:last-child) {
      border-bottom: 1px solid transparent;
    }
  }
}

.vuln-nav.active {
  border-color: $sidebar-active-border-color;
}

.loader {
  display: flex;
  justify-content: center;
  align-items: center;
  &__msg {
    margin-left: 0.5rem;
    &__sub {
      color: lighten($color-gray, 20%);
      font-size: 0.8rem;
      padding-top: 0.3rem;
    }
  }
}
</style>
