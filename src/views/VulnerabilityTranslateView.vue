<template>
  <div class="vulnerability contain-height">
    <NavBar class="sitenav">
      <BreadCrumb
        v-bind:breadcrumb="[
          { label: 'Projects', route: '/projects' },
          {
            label: 'Vulnerabilities',
            route: null
          },
          {
            label: $route.params.id,
            route: `/vulnerabilities/${$route.params.id}`
          },
          {
            label: 'translate',
            route: null
          }
        ]"
      />
    </NavBar>
    <div class="side-panel-layout">
      <aside class="sidebar">
        <nav class="vulnerability-nav">
          <h3 class="sidebar__header">Vulnerabilities</h3>
          <ul v-if="vulnerabilities">
            <li
              v-for="v in vulnerabilities.en"
              :key="v.id"
              class="vuln-nav"
              v-bind:class="{ active: v.id == $route.params.id }"
            >
              <SidebarVulnerability
                v-bind:vulnerability="v"
                v-bind:isActive="v.id == $route.params.id"
              />
            </li>
          </ul>
          <div v-else>not loaded</div>
        </nav>
      </aside>
      <main class="main">
        <div v-if="isLoadingVulnerabilities" class="contain-centered">
          <div class="loader">
            <DownloadLoader />
            <div class="loader__msg">
              <div>Initializing Vulnerabilities...</div>
              <div class="loader__msg__sub">
                Please wait, this may take a few minutes.
              </div>
            </div>
          </div>
        </div>
        <div
          v-else-if="
            !isLoadingVulnerabilities &&
              !getVulnerability($route.params.id, 'en')
          "
          class="not-found contain-centered"
        >
          <AlertIcon />
          Uh oh! Vulnerability with this ID doesn't exist.
        </div>
        <VulnerabilityTranslate
          v-else
          v-bind:enVulnerability="getVulnerability($route.params.id, 'en')"
          v-bind:jaVulnerability="getVulnerability($route.params.id, 'ja')"
        />
      </main>
    </div>
    <FooterBar class="footer-bar" />
  </div>
</template>

<script lang="ts">
import { Component, Vue } from "vue-property-decorator";
import VulnerabilityAPIService from "@/services/VulnerabilityAPIService";
import NavBar from "@/components/NavBar.vue";
import FooterBar from "@/components/FooterBar.vue";
import BreadCrumb from "@/components/BreadCrumb.vue";
import DownloadLoader from "@/components/DownloadLoader.vue";
import VulnerabilityTranslate from "@/components/VulnerabilityTranslate.vue";
import PlatformIcon from "@/components/PlatformIcon.vue";
import SidebarVulnerability from "@/components/SidebarVulnerability.vue";
import AlertIcon from "vue-material-design-icons/Alert.vue";

@Component({
  components: {
    NavBar,
    BreadCrumb,
    DownloadLoader,
    VulnerabilityTranslate,
    PlatformIcon,
    SidebarVulnerability,
    FooterBar,
    AlertIcon
  }
})
export default class VulnerabilityTranslateView extends Vue {
  private id = this.$route.params.id;
  private vulnerabilities = [];

  private branch = localStorage.getItem("branch");
  private canEdit = this.branch !== "master";
  private canWrite = this.branch !== "master";
  private isLoadingVulnerabilities = true;

  getVulnerability(id: string, lang: string) {
    const vid = parseInt(id);
    const v = this.$store.getters.getVulnerability(vid, lang);
    return v;
  }

  initModifiedVulnerabilities() {
    const modifiedVulns = localStorage.getItem("modifiedVulnerabilities");
    if (modifiedVulns) {
      const mvs = JSON.parse(modifiedVulns);
      if (
        Object.keys(mvs["en"]).length !== 0 &&
        Object.keys(mvs["ja"]).length !== 0
      ) {
        for (const lang of ["en", "ja"]) {
          Object.keys(mvs[lang]).forEach(k => {
            this.$store.commit("saveModifiedVulnerability", {
              lang: lang,
              id: k,
              hash: mvs[lang][k]["hash"],
              vulnerability: mvs[lang][k]["vulnerability"]
            });
          });
        }
        return;
      }
    }

    this.$store.commit("initModifiedVulnerabilities");
    const modifiedVulnerabilities = this.$store.getters
      .getModifiedVulnerabilities;
    localStorage.setItem(
      "modifiedVulnerabilities",
      JSON.stringify(modifiedVulnerabilities)
    );
  }

  formatVulnerability(v) {
    return {
      id: v.id,
      key: v.key,
      platform: v.platform,
      name: v.name,
      question: v.question,
      summary: v.description,
      description: v.intro,
      businessImplication: v.business_implication,
      compliant: v.compliant,
      nonCompliant: v.non_compliant,
      successMessage: v.success_message,
      relatedTo: v.related_to
    };
  }

  async fetchVulnerabilities(branch = "master", langs = ["en", "ja"]) {
    let vulns = {};
    try {
      vulns = await VulnerabilityAPIService.get(branch).then(
        response => response.data
      );
    } catch (err) {
      this.isLoadingVulnerabilities = false;
      return false;
    }
    const vulnerabilities = {};
    for (const lang of langs) {
      vulnerabilities[lang] = vulns[lang].reduce((acc, curr) => {
        acc[curr.id] = this.formatVulnerability(curr);
        this.$store.commit("saveVulnerability", {
          lang: [lang],
          vulnerability: acc[curr.id]
        });
        return acc;
      }, {});
    }
    this.isLoadingVulnerabilities = false;
    return vulnerabilities;
  }

  async getVulnerabilities() {
    const vulnerabilities = localStorage.getItem("vulnerabilities");
    if (vulnerabilities) {
      this.vulnerabilities = JSON.parse(vulnerabilities);
      if (
        Object.keys(this.vulnerabilities["en"]).length !== 0 &&
        Object.keys(this.vulnerabilities["ja"]).length !== 0
      ) {
        for (const lang of ["en", "ja"]) {
          Object.values(this.vulnerabilities[lang]).forEach(v => {
            this.$store.commit("saveVulnerability", {
              lang: lang,
              vulnerability: v
            });
          });
        }
        this.isLoadingVulnerabilities = false;
        this.initModifiedVulnerabilities();
        return;
      }
    }

    await this.fetchVulnerabilities();
    if (this.$store.getters.hasEditBranch) {
      this.fetchVulnerabilities(this.$store.getters.getBranch, ["ja"]);
    }
    this.vulnerabilities = await this.$store.getters.getVulnerabilities;

    localStorage.setItem(
      "vulnerabilities",
      JSON.stringify(this.vulnerabilities)
    );

    this.initModifiedVulnerabilities();
    return;
  }

  sort(arr) {
    return arr.reduce((acc, curr) => {
      acc[curr.id] = curr;
      return acc;
    }, {});
  }

  restoreModifiedVulnerability() {
    const mvs = this.$store.getters.getModifiedVulnerabilities["ja"];
    return Object.keys(mvs)
      .filter(k => !!mvs[k]["vulnerability"])
      .forEach(k => {
        return Object.keys(mvs[k]["vulnerability"]).forEach(f => {
          this.vulnerabilities["ja"][k][f] = mvs[k]["vulnerability"][f];
        });
      });
  }

  mounted() {
    this.getVulnerabilities();
    this.restoreModifiedVulnerability();
  }
}
</script>

<style scoped lang="scss">
.vulnerability {
  position: relative;
}
.sitenav {
  margin-bottom: -$navbar-height;
  z-index: 2;
}
.side-panel-layout {
  height: 100%;
  padding-top: $navbar-height;
  padding-bottom: $navbar-height;
  display: flex;
  overflow: hidden;
  position: relative;
  z-index: 1;
}
.footer-bar {
  height: $navbar-height;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1;
  box-shadow: -1px 0 12px rgba(lighten($color-text, 45%), 0.5);
  border-top: 1px solid lighten($color-text, 58%);
}

.sidebar {
  overflow-y: scroll;
  background: $sidebar-bg;
  width: 100%;

  @media (min-width: 768px) {
    width: 20rem;
  }

  &__header {
    text-transform: uppercase;
    color: $sidebar-title-color;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.03rem;
    padding: 0.8rem 1rem 0.5rem;
  }
}
.main {
  overflow-y: scroll;
  width: 100%;
  flex: 1;
  background: $main-bg;
}

.vulnerability-nav {
  ul {
    padding: 0.3rem 0 2rem;
  }
  li {
    &:not(:last-child) {
      border-bottom: 1px solid transparent;
    }
  }
}

.vuln-nav.active {
  border-color: $sidebar-active-border-color;
}

.loader {
  display: flex;
  justify-content: center;
  align-items: center;
  &__msg {
    margin-left: 0.5rem;
    &__sub {
      color: lighten($color-gray, 20%);
      font-size: 0.8rem;
      padding-top: 0.3rem;
    }
  }
}
</style>
